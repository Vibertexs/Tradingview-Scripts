//@version=5
indicator("Bar Range Volatility Regime + Direction (Hysteresis)", shorttitle = "RangeVolDirH", overlay = false, max_bars_back = 5000)

// ─── Inputs ────────────────────────────────────────────────────────────────────
lenBase   = input.int(100, "Base Length (μ, σ)", minval = 10)
lenLook   = input.int(10,  "Current Window Y",  minval = 1)

useZscore = input.bool(true, "Use Z-Score Mode?",
     tooltip = "ON = (avgRangeY - μ) / σ\nOFF = avgRangeY / μ (ratio mode)")

// For z-score mode, something like 1 / -1 is typical.
// For ratio mode you'd use High≈1.5, Low≈0.7 etc.
highThresh = input.float(0.9,  "High Vol Threshold (entry)", step = 0.1)
lowThresh  = input.float(-1.0, "Low Vol Threshold (entry)",  step = 0.1)

// Directionality filter (0–1)
effThresh  = input.float(0.5, "Directional Threshold (entry, 0–1)", minval = 0.0, maxval = 1.0, step = 0.05)

// Internal exit thresholds (hysteresis, no extra inputs)
highThreshExit = highThresh * 0.8          // leave high-vol regime when we calm down a bit
lowThreshExit  = lowThresh * 0.8           // leave low-vol regime when we revert toward normal
effThreshExit  = effThresh * 0.8           // leave directional state if efficiency drops

// ─── Core Volatility Calculations ─────────────────────────────────────────────

// 1. Bar height (range)
barRange = high - low

// 2. Base stats over lenBase bars
mu  = ta.sma(barRange, lenBase)       // average bar range (μ)
sig = ta.stdev(barRange, lenBase)     // std dev of bar range (σ)

// 3. Average range over current Y bars
avgRangeY = ta.sma(barRange, lenLook)

// 4. Z-score and ratio versions
z     = sig != 0.0 ? (avgRangeY - mu) / sig : 0.0
ratio = mu  != 0.0 ? avgRangeY / mu        : 1.0

// Value we actually use, depending on mode
val = useZscore ? z : ratio

// 5. Volatility regime (raw, no hysteresis yet)
isHighVolRaw = val > highThresh
isLowVolRaw  = val < lowThresh

// ─── Directionality (Kaufman-style Efficiency) over lenLook ──────────────────
float path = na
if bar_index > lenLook + 1
    path := 0.0
    for i = 0 to lenLook - 1
        path += math.abs(close[i] - close[i + 1])

float net = na
if bar_index > lenLook
    net := math.abs(close - close[lenLook])

float eff = na
eff := not na(path) and path > 0 and not na(net) ? net / path : 0.0

// ─── State Machine (borrowed concept from Chop script) ───────────────────────

// Regime states with hysteresis
var bool inTrendExpansion  = false   // high vol + directional
var bool inWhipsawExpansion = false  // high vol + non-directional
var bool inCompression     = false   // low vol

// Convenience aliases
valNow = val
effNow = eff

// 1) Trend expansion state (blue)
// Enter: high vol AND eff >= effThresh
// Exit:  val drops below highThreshExit OR eff drops below effThreshExit
if not inTrendExpansion
    if valNow > highThresh and effNow >= effThresh
        inTrendExpansion := true
        inWhipsawExpansion := false
else
    if valNow < highThreshExit or effNow < effThreshExit
        inTrendExpansion := false

// 2) Whipsaw expansion state (red)
// Enter: high vol AND eff < effThresh
// Exit:  val drops below highThreshExit OR eff recovers above effThresh
if not inWhipsawExpansion
    if valNow > highThresh and effNow < effThresh
        inWhipsawExpansion := true
        inTrendExpansion := false
else
    if valNow < highThreshExit or effNow >= effThresh
        inWhipsawExpansion := false

// 3) Compression state (green)
// Enter: val < lowThresh
// Exit:  val > lowThreshExit  (less negative → back toward normal)
if not inCompression
    if valNow < lowThresh
        inCompression := true
else
    if valNow > lowThreshExit
        inCompression := false

// ─── Plots ────────────────────────────────────────────────────────────────────

// Main line (either z-score or ratio)
plot(val, title = "Volatility Value", color = color.white, linewidth = 2)

// Optional: plot efficiency so you can see directionality
plot(eff, title = "Directional Efficiency (0–1)", color = color.new(color.blue, 60))

// Baseline: 0 for z-score, 1 for ratio mode
baseline = useZscore ? 0.0 : 1.0
hline(baseline, "Baseline", color = color.new(color.gray, 60), linestyle = hline.style_dotted)

// Thresholds
hline(highThresh, "High Vol Threshold (entry)", color = color.new(color.red, 40), linestyle = hline.style_dashed)
hline(lowThresh,  "Low Vol Threshold (entry)", color = color.new(color.green, 40), linestyle = hline.style_dashed)

// Background coloring for stable regimes
bgcolor(     inTrendExpansion   ? color.new(color.blue,  85) :     inWhipsawExpansion ? color.new(color.red,   85) :     inCompression      ? color.new(color.green, 88) : na)
