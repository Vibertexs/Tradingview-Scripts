//@version=5
indicator("RSI Trends v4", format=format.price, precision=2, timeframe="", timeframe_gaps=true)

// === INPUT SETTINGS ===
rsiLengthInput = input.int(60, minval=1, title="RSI Length")
rsiSourceInput = input.source(close, "Source")
maLengthInput = input.int(30, title="JMA Length")
jmaPhaseInput = input.int(50, minval=-100, maxval=100, step=1, title="JMA Phase")
jmaPowerInput = input.int(2, minval=1, maxval=5, step=1, title="JMA Power")

bandGap = input.int(4, minval=1, maxval=25, title="Gap from 50")
rsiLookback = input.int(55, title="Range Look Back Period")

preserveLastColor = input.bool(true, title="Preserve Last Color When Flat")

// === CALCULATE RSI ===
up = ta.rma(math.max(ta.change(rsiSourceInput), 0), rsiLengthInput)
down = ta.rma(-math.min(ta.change(rsiSourceInput), 0), rsiLengthInput)
rsi = down == 0 ? 100 : up == 0 ? 0 : 100 - (100 / (1 + up / down))

// === JMA FUNCTION ===
jma(src, length, phase, power) =>
    var float e0 = na
    var float e1 = na
    var float e2 = na
    var float y = na
    
    phaseRatio = phase < -100 ? 0.5 : phase > 100 ? 2.5 : phase / 100 + 1.5
    beta = 0.45 * (length - 1) / (0.45 * (length - 1) + 2)
    alpha = math.pow(beta, power)
    
    e0 := (1 - alpha) * src + alpha * nz(e0[1])
    e1 := (src - e0) * (1 - beta) + beta * nz(e1[1])
    e2 := (e0 + phaseRatio * e1 - nz(y[1])) * math.pow(1 - alpha, 2) + math.pow(alpha, 2) * nz(e2[1])
    y := e2 + nz(y[1])
    y

// === SMOOTH RSI with JMA ===
rsiJMA = jma(rsi, maLengthInput, jmaPhaseInput, jmaPowerInput)

// === STATIC BANDS AROUND 50 ===
rsiUpperBandValue = 50 + bandGap
rsiLowerBandValue = 50 - bandGap
bandMidpoint = 50

// === RANGE DETECTION FUNCTION ===
isPingPongMarket() =>
    maxConsecutive = 5
    aboveCount = 0
    belowCount = 0
    for i = 0 to rsiLookback
        if rsiJMA[i] > bandMidpoint
            aboveCount += 1
            belowCount := 0
        else if rsiJMA[i] < bandMidpoint
            belowCount += 1
            aboveCount := 0
        if aboveCount > maxConsecutive or belowCount > maxConsecutive
            false
    true

// === JMA COLORING ===
numberOfTimesInRange = 0
for i = 0 to rsiLookback
    if (rsiJMA[i] < rsiUpperBandValue and rsiJMA[i] > rsiLowerBandValue)
        numberOfTimesInRange += 1

rsiJMAColor = color.gray
if (isPingPongMarket() and numberOfTimesInRange >= rsiLookback)
    rsiJMAColor := color.purple
else if (rsiJMA > rsiUpperBandValue)
    rsiJMAColor := color.green
else if (rsiJMA < rsiLowerBandValue)
    rsiJMAColor := color.red

isPurple = rsiJMAColor == color.purple


// === PLOTS ===
plot(rsi, "RSI", color=#7E57C2)
plot(rsiJMA, "RSI-based JMA", color=rsiJMAColor)


// === STATIC BANDS PLOTS ===

plot(bandMidpoint, title="RSI Midpoint (50)", color=color.new(color.orange, 50), linewidth=1)

fill(plot(rsiUpperBandValue), plot(rsiLowerBandValue), color=color.rgb(126, 87, 194, 90), title="RSI Background Fill")


