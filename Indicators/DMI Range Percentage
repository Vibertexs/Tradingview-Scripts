//@version=6
indicator(title="DMI Range Percentage", format=format.price, precision=4, timeframe="", timeframe_gaps=true)

// lensig = input.int(14, title="ADX Smoothing", minval=1)
len    = input.int(14, minval=1, title="DI Length")

// New inputs
lookback       = input.int(500, "Lookback for range threshold", minval=50)
percentRanging = input.float(50.0, "Percent of bars considered ranging", minval=1.0, maxval=99.0, step=0.5)

up       = ta.change(high)
down     = -ta.change(low)
plusDM   = na(up)   ? na : (up > down and up > 0   ? up   : 0)
minusDM  = na(down) ? na : (down > up and down > 0 ? down : 0)
trur     = ta.rma(ta.tr, len)
plus     = fixnan(100 * ta.rma(plusDM,  len) / trur)
minus    = fixnan(100 * ta.rma(minusDM, len) / trur)
middle   = (plus + minus) / 2.0
mid      = ta.ema(middle, len)

plot(mid, color=color.red, title="mid")

// sum = plus + minus  

distanceMin  = math.abs(mid - minus)
distancePlus = math.abs(mid - plus)

// plot(distanceMin,  color=color.red,   title="distanceMin")
// plot(distancePlus, color=color.green, title="distancePlus")

midModified = ta.ema((distanceMin + distancePlus) / 2.0, len)
plot(midModified, color=color.yellow, title="midModified")

// ── Auto threshold so that ~percentRanging% of midModified are below it over 'lookback' bars
// This is the percentile of midModified over the trailing window.
autoThreshold = ta.percentile_linear_interpolation(midModified, lookback, percentRanging)

// Plot the auto-picked threshold line
plot(autoThreshold, color=color.white, title="Auto Range Threshold")

// Optional: 1 = ranging, 0 = not ranging (for your bot)
isRanging = not na(autoThreshold) and midModified <= autoThreshold ? 1 : 0
plot(isRanging, title="Ranging Flag (1 = range)", style=plot.style_columns, color=isRanging == 1 ? color.new(color.yellow, 0) : color.new(color.gray, 90))
